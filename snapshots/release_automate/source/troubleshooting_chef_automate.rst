.. THIS PAGE IS IDENTICAL TO docs.chef.io/troubleshooting_chef_automate.html BY DESIGN
.. THIS PAGE IS LOCATED AT THE /release/automate/ PATH.

=====================================================
Troubleshooting Chef Automate
=====================================================

.. include:: ../../includes_chef_automate/includes_chef_automate_mark.rst 

Build nodes
=====================================================

The following are possible issues you might run into when using build nodes.

Issue: Waiting for builder
-----------------------------------------------------

If this is a new Chef Automate setup and you see "Waiting for builder" in your log output, but no 
build nodes are set up yet, that means the Chef Automate server and Chef server are having trouble communicating.

Issue: No build nodes available
-----------------------------------------------------

If you see  "No build nodes available" in your log output, then that means you need to set some up. 
If you already have and are still seeing that error, then it's time to see if they've 
registered with the chef server correctly.  What correctly means in this case is something 
that matches your build node query.

By default, Chef Automate build nodes generated by ``delivery-ctl install-build-node`` are tagged 
as ``delivery-build-node``. If your delivery.rb contains a custom search query 
(``delivery['default_search']`` is set), try appending ``" OR tags:delivery-build-node"`` to your query.

If you are trying to debug a particular build node and want to ensure that one is available for your projects, 
then modify the build-nodes default search for your project as described in :doc:`Configure a Project </config_json_delivery>`.

SAML
=======================================================

When setting up SAML authentication, you might run into the following issues where you cannot sign in with SAML.

Issue: The browser shows a blank page
-----------------------------------------------------

If both of these conditons are true:

* The URL of the blank page is ``https://<yourChef AutomateDomain>/api/v0/e/<enterprise>/saml/auth/<my-saml-name>``
* The logs show ``[error] Ranch listener http terminated in auth_hand_saml_auth:handle/2 with reason: no match of right hand value false in base64:decode_binary/2 line 212``

then the SAML IdP certificate stored in the database is not correct: it's not base64-encoded.

You can verify that a certificate is correctly copied by doing the following:

#. Save the certificate to a file (e.g. `CERT`).
#. In the command line, run ``base64 -D CERT | openssl x509 -inform DER -text -noout``.

   The output should be the certificate information, for example

   .. code-block:: none

      Certificate:
         Data:
            Version: 3 (0x2)
            Serial Number:
                  01:4b:41:db:a2:9c
            Signature Algorithm: sha1WithRSAEncryption
            Issuer: C=US, ST=California, L=San Francisco, O=Okta, OU=SSOProvider, CN=getchef/emailAddress=info@okta.com
      ...

      .. note:: The `base64` CLI tool is not as strict in decoding Base64 as Erlang is.

If the commands above displays the certificate info, but you still get the error pattern, try running your certificate through Erlang:

#. Open an Erlang shell: ``erl``
#. Type ``{ok, Content} = file:read_file(Path).`` to read the file (note the period at the end)
#. Type ``base64:decode(Content).`` to try decoding the base64-encoded certificate.

If the certificate can be decoded, you would see something like

.. code-block:: none

   > base64:decode(Content).
   <<48,130,3,158,48,130,2,134,160,3,2,1,2,2,6,1,75,65,219,
     162,156,48,13,6,9,42,134,72,134,...>>

and if it can't be decoded

.. code-block:: none

   > base64:decode(Content).
   ** exception error: no match of right hand side value false
       in function  base64:decode_binary/2 (base64.erl, line 212)

Issue: The browser shows the login UI with "SAML login failed!"
-----------------------------------------------------------------

Case #1
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

If you see this error and the logs show ``Invalid assertion {assertion,{error,cert_not_accepted}}``, then the stored certificate is 
base64-encoded, but is not the certificate used by the IdP for signing the assertion response.

To find the certificate that was used for this, you can examine the assertions given by the IdP on successful login:

#. Open Chrome's "Developer Tools" (Alt+Cmd+i on OSX) > Network (4th tab)
#. Select `Preserve Log` (2nd row) and `All` (3rd row)
#. Try logging in via SAML again
#. Find the request to `consume` (Name column)
#. In the`Header` tab, scroll down to `Form Data` and copy the `SAMLResponse` data
#. Go to https://www.samltool.com/decode.php and paste the SAMLResponse, click `decode and inflate XML`
#. Compare the certificate in the XML document (``ds:X509Certificate`` or a similar tag) to the certificate stored in the SAML Setup page.

Case #2
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

If you see this error and the logs show ``[error] Invalid assertion bad_recipient``, then the "Assertion Consumption Service" (ACS) 
endpoint configured with the IdP is not correct.

A configuration mismatch of this kind most likely breaks the interaction completely. Actually seeing this error hints at a minor 
mismatch -- most likely concering the `api_proto` setting.

Follow the steps above to examine the assertions returned from the IdP and verify that the recipient of the assertion response matches Chef Automate's saml/consume endpoint:

.. code-block:: none

   <?xml version="1.0" encoding="UTF-8"?>
     <saml2p:Response
        xmlns:saml2p="urn:oasis:names:tc:SAML:2.0:protocol"
        Destination="http://<yourChef AutomateDomain>/api/v0/e/cd/saml/consume" <<< THIS NEEDS TO MATCH
        ID="id106938446989890821534691506"
        InResponseTo="_209b55372ca56aee1457a2f6a5eced8e"
        IssueInstant="2016-06-13T12:03:04.758Z"
        Version="2.0"
        xmlns:xs="http://www.w3.org/2001/XMLSchema">

Case #3
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

If you see this error and the logs show ``[error] Invalid assertion bad_in_response_to``, then the response doesn't match a request.

.. code-block:: none

   <?xml version="1.0" encoding="UTF-8"?>
     <saml2p:Response
        xmlns:saml2p="urn:oasis:names:tc:SAML:2.0:protocol"
        Destination="http://<delivery>/api/v0/e/cd/saml/consume"
        ID="id106938446989890821534691506"
        InResponseTo="_209b55372ca56aee1457a2f6a5eced8e" <<< THIS NEEDS TO MATCH
        IssueInstant="2016-06-13T12:03:04.758Z"
        Version="2.0"
        xmlns:xs="http://www.w3.org/2001/XMLSchema">

This can happen when either the IdP is not compliant to the SAML specs, or when the assertion is too late, that is, when the initiation of the SAML login process 
(the redirect to your IdP) has been longer than 15 minutes.

Issue: The browser shows the login UI with "Invalid user, login failed!"
-------------------------------------------------------------------------

Chef Automate does not have a user-record for the user information from the SAML asssertion.
This can be triggered by either:

* Initiating SAML authentication when trying to log in by entering a username of a Chef Automate user with authentication type SAML
* When redirected to the SAML IdP, authenticating as a different user (not known to Chef Automate)

This can also indicate a change in NameId settings.

Visibility
====================================================================

The following is a possible issue you might run into when using the visibility capabilities in Chef Automate.

Issue: Data does not show up in Chef Automate UI
------------------------------------------------------------------------------------

.. include:: ../../includes_chef_automate/includes_chef_automate_visibility_no_data_troubleshoot.rst
